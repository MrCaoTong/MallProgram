# 服务器部署上线详细指南（Node.js 项目专用，宝塔面板+域名解析）

> 本指南适合零基础新手，详细讲解在宝塔面板和已完成域名解析后，如何完成服务器环境配置、Nginx反向代理、HTTPS证书申请、Node.js项目部署、微信小程序后台配置等上线流程。

---

## ⚠️ 重要提醒

- 确保你的域名已经解析到服务器IP地址
- 确保你的域名已经完成ICP备案（中国大陆服务器必须）
- 准备好在微信公众平台配置域名白名单

---

## 一、宝塔面板基础操作

1. **登录宝塔面板**
   - 打开浏览器，访问：http://你的服务器IP:8888
   - 输入宝塔面板的账号密码（首次安装时会显示）
   - 如果忘记密码，可通过SSH连接服务器，执行：`bt default` 查看默认信息

2. **安装LNMP环境**
   - 首次登录后，宝塔会自动弹出"推荐安装套件"窗口
   - 选择"LNMP"（推荐：Nginx 1.20、MySQL 5.7、PHP 7.4）
   - 点击"一键安装"，等待安装完成（约10-20分钟）
   - 安装完成后，在左侧菜单可以看到"网站"、"数据库"、"软件商店"等选项

3. **开放服务器端口**
   - 在宝塔面板左侧菜单点击"安全"
   - 在"防火墙"中添加以下端口：
     * 80（HTTP）
     * 443（HTTPS）
     * 22（SSH）
     * 8888（宝塔面板）
     * 38252（你的MySQL端口，实际以宝塔显示为准）
     * 4000（mall-server端口，实际以你的Node服务端口为准）
   - 同时在你的云服务器控制台（阿里云/腾讯云等）安全组中也开放这些端口

4. **安装Node.js环境**
   - 在宝塔面板左侧菜单点击"软件商店"
   - 搜索"Node.js"，点击"安装"
   - 选择版本16.x或18.x（推荐），点击"安装"
   - 安装完成后，在SSH终端验证：`node -v` 和 `npm -v`

---

## 二、域名绑定与站点创建（Node.js 项目专用）

1. **创建 mall-server 站点**
   - 在宝塔面板左侧菜单点击"网站"
   - 点击"添加站点"按钮
   - 填写以下信息：
     * 域名：`www.ctdevelopment.cn`
     * 根目录：`/www/wwwroot/www.ctdevelopment.cn`
     * FTP/数据库：都不用勾选
     * PHP版本：选“纯静态”或任意，不影响Node项目
   - 点击"提交"创建站点

2. **创建 mall-admin 站点**
   - 域名：`admin.ctdevelopment.cn`
   - 根目录：`/www/wwwroot/admin.ctdevelopment.cn`
   - 其他同上

3. **记录重要信息**
   - 网站根目录：实际创建的目录路径
   - 数据库名、用户名、密码、主机、端口（在宝塔“数据库”页面可查）

---

## 三、Nginx 配置反向代理（Node.js 项目）

1. **mall-server 反向代理**
   - 在站点管理页面，点击"反向代理"选项卡
   - 点击"添加反向代理"
   - 填写配置：
     * 代理名称：mall-server
     * 目标URL：`http://127.0.0.1:4000`（你的Node服务端口）
     * 启用：勾选
   - 点击"提交"保存

2. **mall-admin 静态资源站点**
   - 不需要反向代理，直接上传前端打包后的 dist 目录内容到根目录即可

3. **验证反向代理配置**
   - 保存后，在反向代理列表中可以看到配置
   - 确保状态为"启用"

---

## 四、HTTPS 证书申请与配置

1. **申请SSL证书**
   - 在站点管理页面，点击"SSL"选项卡
   - 选择"Let's Encrypt"（免费证书）
   - 勾选"强制HTTPS"
   - 点击"申请"按钮
   - 等待证书申请完成（通常1-2分钟）

2. **验证证书状态**
   - 申请成功后，证书状态显示为"已部署"
   - 强制HTTPS已开启
   - 可以通过 https://你的域名 访问测试

3. **常见问题解决**
   - 如果申请失败，检查：
     * 域名是否已解析到服务器IP
     * 域名是否已备案（中国大陆服务器必须）
     * 80端口是否开放
     * 是否有其他服务占用80端口

---

## 五、项目部署（mall-server、mall-admin）

### 1. 上传 mall-server 代码

- 使用宝塔文件管理器或 SFTP 工具（如 FileZilla、WinSCP）上传 mall-server 项目到 `/www/wwwroot/www.ctdevelopment.cn`
- 上传完成后解压（如果是压缩包）

### 2. 配置 mall-server 环境变量

- 在 mall-server 目录下新建 `.env.production` 文件，内容如下（以你的实际数据库信息为准）：

  ```env
  DB_HOST=localhost
  DB_PORT=38252
  DB_USER=mall
  DB_PASSWORD=你的数据库密码
  DB_NAME=mall

  BASE_URL=https://www.ctdevelopment.cn
  ```

- 如有微信小程序、JWT等配置，也一并写入

### 3. 安装依赖并启动 mall-server

- 通过SSH连接服务器，进入 mall-server 目录：

  ```bash
  cd /www/wwwroot/www.ctdevelopment.cn
  npm install
  ```

- 启动服务（推荐用 pm2）：

  ```bash
  NODE_ENV=production pm2 start app.js --name mall-server
  # Windows 下用 $env:NODE_ENV="production"; pm2 start app.js --name mall-server
  ```

- 设置开机自启：

  ```bash
  pm2 save
  pm2 startup
  ```

- 查看服务状态：

  ```bash
  pm2 status
  pm2 logs mall-server
  ```

### 4. 部署 mall-admin 前端

- 本地 mall-admin 目录运行 `npm run build`，生成 dist 文件夹
- 用宝塔"文件"管理器进入 `/www/wwwroot/admin.ctdevelopment.cn/`
- 把 dist 文件夹里的所有内容（不是整个 dist 文件夹！）上传到该目录下

---

## 六、数据库导入

1. **使用宝塔面板导入**
   - 在宝塔面板左侧菜单点击"数据库"
   - 找到你创建的数据库，点击"管理"
   - 在phpMyAdmin中，选择你的数据库
   - 点击"导入"选项卡
   - 选择你的 mall.sql 文件
   - 点击"执行"导入数据

2. **使用命令行导入**
   - 通过SSH连接服务器
   - 执行以下命令（以你的实际用户名、端口为准）：
     ```bash
     mysql -u mall -p -hlocalhost -P38252 mall < /path/to/mall.sql
     ```
   - 输入数据库密码

3. **验证数据导入**
   - 在phpMyAdmin中查看是否有以下表：
     * user
     * goods
     * category
     * order
     * cart
     * order_goods
     * 等等...

---

## 七、小程序后台配置

1. **配置服务器域名**
   - 登录微信公众平台：https://mp.weixin.qq.com
   - 进入你的小程序后台
   - 点击"开发"->"开发设置"
   - 在"服务器域名"中配置：
     * request合法域名：https://www.ctdevelopment.cn
     * uploadFile合法域名：https://www.ctdevelopment.cn
     * downloadFile合法域名：https://www.ctdevelopment.cn
   - 点击"保存"按钮

2. **上传微信校验文件**
   - 按微信后台提示，将校验文件上传到 `/www/wwwroot/www.ctdevelopment.cn` 根目录

3. **上传小程序代码**
   - 在微信开发者工具中，修改 mall-miniprogram 的 config 配置
   - 将 baseUrl 改为你的服务器域名
   - 上传代码到微信后台
   - 提交审核并发布

---

## 八、测试与验证

1. **测试API接口**
   - 访问 https://www.ctdevelopment.cn/api/goods 测试商品接口
   - 确认返回正确的JSON数据

2. **测试管理后台**
   - 访问 https://admin.ctdevelopment.cn
   - 测试登录、商品管理、订单管理等功能

3. **测试小程序**
   - 在微信开发者工具中测试小程序功能
   - 上传体验版，在真机上测试
   - 确认所有功能正常

---

## 九、常见问题与排查

1. **域名相关问题**
   - 问题：域名无法访问
   - 解决：检查域名解析、备案状态、服务器防火墙

2. **HTTPS证书问题**
   - 问题：证书申请失败
   - 解决：确认域名解析正确、80端口开放、域名已备案

3. **数据库连接问题**
   - 问题：数据库连接失败
   - 解决：检查数据库配置、用户权限、防火墙设置

4. **Nginx配置问题**
   - 问题：502 Bad Gateway
   - 解决：检查反向代理配置、Node.js服务是否启动、端口是否正确

5. **文件上传问题**
   - 问题：上传文件失败
   - 解决：检查uploads目录权限、磁盘空间、文件大小限制

6. **小程序接口问题**
   - 问题：接口返回401或403
   - 解决：检查域名白名单、HTTPS证书、接口鉴权逻辑

---

## 十、性能优化建议

1. 服务器优化
   - 开启Nginx gzip压缩
   - 配置静态文件缓存
   - 优化数据库查询

2. 安全加固
   - 修改默认端口
   - 设置强密码
   - 定期更新系统

3. 监控维护
   - 设置日志监控
   - 配置错误告警
   - 定期备份数据

---

> 如遇特殊问题，建议：
> 1. 查看宝塔面板日志
> 2. 查看PM2日志：pm2 logs mall-server
> 3. 查看Nginx错误日志
> 4. 百度/谷歌搜索具体错误信息
> 5. 查阅官方文档或社区论坛

---

**如需进一步定制或有特殊场景，请随时补充说明！** 